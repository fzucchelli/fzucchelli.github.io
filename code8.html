<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestore Logistico Digitale - Padroneggia SQL</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.7.32/sweetalert2.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.js"></script>
    <style>
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #0072ff 0%, #00c6ff 100%); /* Blue gradient for logistics/tech */
        }
        .table-container {
            max-height: 300px;
            overflow-y: auto;
            background-color: rgba(30, 41, 59, 0.8);
            border-radius: 0.5rem;
        }
        .sql-editor {
            font-family: 'Courier New', monospace;
            background: #1e293b;
            color: #e2e8f0;
            border-radius: 0.5rem;
        }
        .animate-pulse-slow { /* Changed from bounce to pulse for a more "tech" feel */
            animation: pulse 2.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        /* Custom scrollbar for table containers */
        .table-container::-webkit-scrollbar { width: 8px; }
        .table-container::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
        .table-container::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 10px; }
        .table-container::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.5); }

        #query-results table, #table-preview table { border-collapse: separate; border-spacing: 0; }
        #query-results th, #table-preview th { position: sticky; top: 0; background-color: #374151; z-index: 10; }
        .editor-results-grid > div { display: flex; flex-direction: column; }
        .editor-results-grid #sql-editor { flex-grow: 1; }
        .editor-results-grid .table-container { flex-grow: 1; max-height: none; }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">
    <!-- Header -->
    <header class="glass-effect text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <i class="fas fa-truck-fast text-3xl animate-pulse-slow"></i>
                <h1 class="text-2xl font-bold">Gestore Logistico Digitale</h1>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container mx-auto px-4 py-8">
        <!-- Welcome Screen -->
        <div id="welcome-screen" class="text-center text-white animate__animated animate__fadeIn">
            <div class="glass-effect p-8 rounded-2xl max-w-2xl mx-auto">
                <i class="fas fa-route text-6xl mb-4 text-yellow-400"></i>
                <h2 class="text-4xl font-bold mb-4">Benvenuto, Futuro Maestro della Logistica SQL!</h2>
                <p class="text-lg mb-6">Ottimizza le spedizioni e gestisci magazzini complessi. Inizia il tuo viaggio per diventare un esperto di SQL nel mondo della logistica!</p>
                <div class="space-y-4">
                    <button onclick="startQuiz()" class="bg-green-500 hover:bg-green-600 text-white px-8 py-3 rounded-full text-lg font-semibold transition-all transform hover:scale-105">
                        <i class="fas fa-play mr-2"></i>Inizia Percorso Guidato (Quiz)
                    </button>
                    <button onclick="directToLab()" class="bg-blue-500 hover:bg-blue-600 text-white px-8 py-3 rounded-full text-lg font-semibold transition-all transform hover:scale-105">
                        <i class="fas fa-tools mr-2"></i>Vai Diretto al Laboratorio SQL
                    </button>
                </div>
            </div>
        </div>

        <!-- Quiz Section -->
        <div id="quiz-section" class="hidden animate__animated animate__fadeIn">
            <div class="glass-effect p-6 rounded-2xl text-white">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">
                        <i class="fas fa-brain mr-2 text-pink-400"></i>Teoria SQL e Normalizzazione
                    </h2>
                    <div class="text-lg">
                        Domanda <span id="current-question">1</span> di <span id="total-questions">30</span>
                    </div>
                </div>
                
                <div id="quiz-content" class="space-y-6">
                    <div class="bg-gray-800 p-4 rounded-lg">
                        <h3 id="question-text" class="text-xl mb-4"></h3>
                        <div id="answers" class="space-y-3"></div>
                    </div>
                    
                    <div class="flex justify-between">
                        <button onclick="previousQuestion()" id="prev-btn" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-full" disabled>
                            <i class="fas fa-arrow-left mr-2"></i>Precedente
                        </button>
                        <button onclick="nextQuestion()" id="next-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-full">
                            Prossima<i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Syntax Builder Section -->
        <div id="syntax-builder-section" class="hidden animate__animated animate__fadeIn">
            <div class="glass-effect p-6 rounded-2xl text-white">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold mb-4"><i class="fas fa-drafting-compass mr-2 text-teal-400"></i>Costruttore Query Base</h2>
                     <button onclick="skipSyntaxBuilderAndStartLab()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-full text-sm mb-4">
                        Salta al Laboratorio SQL <i class="fas fa-angle-double-right ml-1"></i>
                    </button>
                </div>
                <div id="syntax-challenge-content" class="space-y-4">
                    <p id="syntax-challenge-description" class="text-lg bg-gray-800 p-3 rounded-md"></p>
                    <div class="bg-gray-900 p-4 rounded-lg">
                        <h4 class="font-semibold mb-2 text-gray-300">Query Costruita:</h4>
                        <div id="built-query-display" class="sql-editor p-3 min-h-[3em] whitespace-pre-wrap border border-gray-700"></div>
                    </div>
                    <div class="bg-gray-900 p-4 rounded-lg">
                        <h4 class="font-semibold mb-2 text-gray-300">Pulsanti Sintassi:</h4>
                        <div id="syntax-buttons-container" class="flex flex-wrap gap-2"></div>
                    </div>
                    <div class="flex justify-between items-center mt-6">
                        <div class="flex space-x-2">
                            <button onclick="clearBuiltQuery()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-full"><i class="fas fa-trash mr-2"></i>Pulisci</button>
                            <button onclick="undoLastSyntaxToken()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-full"><i class="fas fa-undo mr-2"></i>Annulla</button>
                        </div>
                        <button onclick="checkSyntaxChallenge()" id="check-syntax-btn" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-full"><i class="fas fa-check mr-2"></i>Verifica</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lab Section -->
        <div id="lab-section" class="hidden animate__animated animate__fadeIn">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Database Schema -->
                <div class="glass-effect p-6 rounded-2xl text-white">
                    <h3 class="text-xl font-bold mb-4"><i class="fas fa-sitemap mr-2 text-green-400"></i>Schema Database Logistico</h3>
                    <div class="space-y-3 text-sm">
                        <div class="bg-gray-800 p-3 rounded-lg">
                            <h4 class="font-semibold text-green-400">Tabella: Sedi</h4>
                            <p class="text-gray-300">idSede (INT PK), nomeSede (TEXT), indirizzoSede (TEXT), cittaSede (TEXT), capacitaMaxPacchi (INT)</p>
                        </div>
                        <div class="bg-gray-800 p-3 rounded-lg">
                            <h4 class="font-semibold text-blue-400">Tabella: Clienti</h4>
                            <p class="text-gray-300">idCliente (INT PK), nomeCliente (TEXT), cognomeCliente (TEXT), tipoCliente (TEXT), email (TEXT), telefono (TEXT)</p>
                        </div>
                        <div class="bg-gray-800 p-3 rounded-lg">
                            <h4 class="font-semibold text-yellow-400">Tabella: Pacchi</h4>
                            <p class="text-gray-300">idPacco (INT PK), codiceTracciamento (TEXT UNIQ), descrizione (TEXT), pesoKg (REAL), volumeM3 (REAL), valoreAssicurato (REAL), idClienteMittente (INT FK), nomeDestinatario (TEXT), indirizzoDestinatario (TEXT), cittaDestinatario (TEXT), capDestinatario (TEXT)</p>
                        </div>
                         <div class="bg-gray-800 p-3 rounded-lg">
                            <h4 class="font-semibold text-purple-400">Tabella: Spedizioni</h4>
                            <p class="text-gray-300">idSpedizione (INT PK), idPacco (INT FK), idSedeCorrente (INT FK), idSedeDestinazioneFinale (INT FK), dataOraEvento (TEXT DATETIME), statoSpedizione (TEXT), noteEvento (TEXT)</p>
                        </div>
                        <div class="bg-gray-800 p-3 rounded-lg">
                            <h4 class="font-semibold text-orange-400">Nota sulla Normalizzazione:</h4>
                            <p class="text-gray-300">La tabella `Prodotto(codProdotto, desc, codMag, qta, indirizzoMag, magazziniere)` (dall'esame) non è in 3NF. `indirizzoMag` e `magazziniere` dipendono da `codMag` (dipendenza transitiva). Si normalizzerebbe in: `ProdottoInfo(codProdotto, desc)`, `Magazzino(codMag, indirizzoMag, respMag)`, `Stock(codProdotto, codMag, qta)`. In questo lab, lavoreremo con lo schema logistico già normalizzato.</p>
                        </div>
                    </div>
                </div>

                <!-- Current Challenge -->
                <div class="glass-effect p-6 rounded-2xl text-white">
                    <h3 class="text-xl font-bold mb-4"><i class="fas fa-bullseye mr-2 text-red-400"></i>Sfida Corrente (<span id="challenge-counter">1</span>/<span id="total-challenges-count">N</span>)</h3>
                    <div id="current-challenge" class="bg-gray-800 p-4 rounded-lg">
                        <h4 id="challenge-title" class="font-semibold mb-2"></h4>
                        <p id="challenge-description" class="text-gray-300 mb-4"></p>
                    </div>
                </div>
            </div>

            <!-- SQL Editor and Results -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6 editor-results-grid">
                <div class="glass-effect p-6 rounded-2xl text-white">
                    <h3 class="text-xl font-bold mb-4"><i class="fas fa-keyboard mr-2 text-cyan-400"></i>Editor SQL</h3>
                    <textarea id="sql-editor" class="sql-editor w-full h-64 p-4 border-2 border-gray-600 focus:border-cyan-400 resize-y" placeholder="Scrivi la tua query SQL..."></textarea>
                    <div class="flex flex-wrap justify-between items-center mt-4 gap-2">
                        <div class="flex space-x-2">
                            <button onclick="testQuery()" class="bg-sky-500 hover:bg-sky-600 text-white px-6 py-2 rounded-full font-semibold"><i class="fas fa-vial mr-2"></i>Testa</button>
                            <button onclick="submitQuery()" id="submit-query-btn" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-full font-semibold"><i class="fas fa-check mr-2"></i>Sottoponi (Ctrl+Enter)</button>
                            <button onclick="clearEditor()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-full"><i class="fas fa-trash mr-2"></i>Pulisci (Ctrl+K)</button>
                        </div>
                        <div class="flex space-x-2">
                             <button onclick="showHint()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-full"><i class="fas fa-lightbulb mr-2"></i>Aiuto</button>
                            <button onclick="showCheatSheet()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-full"><i class="fas fa-book-reader mr-2"></i>Cheat Sheet</button>
                        </div>
                    </div>
                </div>
                <div class="glass-effect p-6 rounded-2xl text-white"> 
                    <h3 class="text-xl font-bold mb-4"><i class="fas fa-poll-h mr-2 text-orange-400"></i>Risultati Query</h3>
                    <div id="query-results" class="table-container">
                        <p class="text-gray-400 p-4">Testa o sottoponi una query per vedere i risultati.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Game Phases Navigation (Progress Bar for Lab) -->
        <div id="game-phases" class="hidden mt-6">
            <div class="glass-effect p-6 rounded-2xl text-white">
                <h3 class="text-xl font-bold mb-4"><i class="fas fa-chart-line mr-2 text-pink-400"></i>Progresso Laboratorio</h3>
                <div id="challenge-progress-bar" class="w-full bg-gray-700 rounded-full h-4 mb-4">
                    <div id="challenge-progress-fill" class="bg-green-500 h-4 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                </div>
                <p id="progress-text" class="text-center">Completa le sfide per diventare un maestro SQL!</p>
            </div>
        </div>
    </div>

    <script>
        let db; 
        let gameState = {
            currentQuiz: 0,
            currentChallengeIndex: 0,
            currentSyntaxChallengeIndex: 0,
            builtQueryTokens: []
        };

        const sampleData = {
            Sedi: [
                {idSede: 1, nomeSede: 'Hub Milano Nord', indirizzoSede: 'Via Logistica 10', cittaSede: 'Milano', capacitaMaxPacchi: 5000},
                {idSede: 2, nomeSede: 'Deposito Roma Est', indirizzoSede: 'Piazza Spedizioni 5', cittaSede: 'Roma', capacitaMaxPacchi: 3500},
                {idSede: 3, nomeSede: 'Centro Smistamento Napoli', indirizzoSede: 'Corso Merci 150', cittaSede: 'Napoli', capacitaMaxPacchi: 4000},
                {idSede: 4, nomeSede: 'Hub Torino Sud', indirizzoSede: 'Strada del Pacco 22', cittaSede: 'Torino', capacitaMaxPacchi: 3000},
                {idSede: 5, nomeSede: 'Filiale Milano Sud', indirizzoSede: 'Viale Industria 7', cittaSede: 'Milano', capacitaMaxPacchi: 2000}
            ],
            Clienti: [
                {idCliente: 1, nomeCliente: 'Mario', cognomeCliente: 'Rossi', tipoCliente: 'Privato', email: 'mario.rossi@email.com', telefono: '3331234567'},
                {idCliente: 2, nomeCliente: 'Tech Solutions Srl', cognomeCliente: '', tipoCliente: 'Azienda', email: 'acquisti@techsolutions.it', telefono: '029876543'},
                {idCliente: 3, nomeCliente: 'Laura', cognomeCliente: 'Bianchi', tipoCliente: 'Privato', email: 'laura.b@email.com', telefono: '3387654321'},
                {idCliente: 4, nomeCliente: 'Global Trade Inc.', cognomeCliente: '', tipoCliente: 'Azienda', email: 'info@globaltrade.com', telefono: '061122334'}
            ],
            Pacchi: [
                {idPacco: 1, codiceTracciamento: 'TRK001', descrizione: 'Libri Scolastici', pesoKg: 5.5, volumeM3: 0.05, valoreAssicurato: 50.0, idClienteMittente: 1, nomeDestinatario: 'Anna Verdi', indirizzoDestinatario: 'Via Studio 1', cittaDestinatario: 'Roma', capDestinatario: '00100'},
                {idPacco: 2, codiceTracciamento: 'TRK002', descrizione: 'Componenti Elettronici', pesoKg: 12.0, volumeM3: 0.1, valoreAssicurato: 350.0, idClienteMittente: 2, nomeDestinatario: 'Marco Neri', indirizzoDestinatario: 'Piazza Affari 10', cittaDestinatario: 'Milano', capDestinatario: '20100'},
                {idPacco: 3, codiceTracciamento: 'TRK003', descrizione: 'Abbigliamento', pesoKg: 2.1, volumeM3: 0.08, valoreAssicurato: 120.0, idClienteMittente: 3, nomeDestinatario: 'Paolo Gialli', indirizzoDestinatario: 'Largo Moda 7', cittaDestinatario: 'Napoli', capDestinatario: '80100'},
                {idPacco: 4, codiceTracciamento: 'TRK004', descrizione: 'Ricambi Auto', pesoKg: 25.0, volumeM3: 0.2, valoreAssicurato: 600.0, idClienteMittente: 4, nomeDestinatario: 'Officina Sprint', indirizzoDestinatario: 'Via Motori 99', cittaDestinatario: 'Torino', capDestinatario: '10100'},
                {idPacco: 5, codiceTracciamento: 'TRK005', descrizione: 'Documenti Importanti', pesoKg: 0.5, volumeM3: 0.01, valoreAssicurato: 10.0, idClienteMittente: 1, nomeDestinatario: 'Ufficio Legale SRL', indirizzoDestinatario: 'Viale Legge 3', cittaDestinatario: 'Milano', capDestinatario: '20121'}
            ],
            Spedizioni: [ 
                {idSpedizione: 1, idPacco: 1, idSedeCorrente: 1, idSedeDestinazioneFinale: 2, dataOraEvento: '2023-10-26 10:00:00', statoSpedizione: 'Preso in carico', noteEvento: 'Pacco ricevuto a Milano Nord'},
                {idSpedizione: 2, idPacco: 1, idSedeCorrente: 1, idSedeDestinazioneFinale: 2, dataOraEvento: '2023-10-26 18:00:00', statoSpedizione: 'In transito', noteEvento: 'Partito da Milano Nord verso Roma Est'},
                {idSpedizione: 3, idPacco: 2, idSedeCorrente: 1, idSedeDestinazioneFinale: 1, dataOraEvento: '2023-10-27 09:30:00', statoSpedizione: 'Preso in carico', noteEvento: 'Pacco ricevuto a Milano Nord'},
                {idSpedizione: 4, idPacco: 3, idSedeCorrente: 3, idSedeDestinazioneFinale: 3, dataOraEvento: '2023-10-27 11:00:00', statoSpedizione: 'In consegna', noteEvento: 'Affidato al corriere per Napoli'},
                {idSpedizione: 5, idPacco: 4, idSedeCorrente: 4, idSedeDestinazioneFinale: 4, dataOraEvento: '2023-10-25 15:00:00', statoSpedizione: 'Consegnato', noteEvento: 'Consegnato a Officina Sprint, Torino'},
                {idSpedizione: 6, idPacco: 2, idSedeCorrente: 1, idSedeDestinazioneFinale: 1, dataOraEvento: '2023-10-27 14:00:00', statoSpedizione: 'In consegna', noteEvento: 'Consegna locale Milano'},
                {idSpedizione: 7, idPacco: 1, idSedeCorrente: 2, idSedeDestinazioneFinale: 2, dataOraEvento: '2023-10-27 08:00:00', statoSpedizione: 'In deposito', noteEvento: 'Arrivato a Roma Est'},
                {idSpedizione: 8, idPacco: 5, idSedeCorrente: 5, idSedeDestinazioneFinale: 5, dataOraEvento: '2023-10-28 10:00:00', statoSpedizione: 'Preso in carico', noteEvento: 'Milano Sud'}
            ]
        };
        
        const quizQuestions = [
            // Original 20
            { question: "Quale comando SQL è usato per recuperare dati?", answers: ["SELECT", "GET", "FETCH", "RETRIEVE"], correct: 0, explanation: "SELECT è il comando standard per interrogare un database." },
            { question: "Cosa significa 'PK' in uno schema di database?", answers: ["Public Key", "Primary Key", "Package Key", "Private Key"], correct: 1, explanation: "PK sta per Primary Key (Chiave Primaria), che identifica univocamente ogni record." },
            { question: "Quale clausola filtra i risultati di una SELECT?", answers: ["FILTER BY", "HAVING", "WHERE", "LIMIT"], correct: 2, explanation: "La clausola WHERE è usata per filtrare i record." },
            { question: "Cos'è una 'Foreign Key' (FK)?", answers: ["Una chiave crittografica", "Una chiave che collega due tabelle", "Una chiave temporanea", "Una chiave per ordinare i dati"], correct: 1, explanation: "Una Foreign Key (Chiave Esterna) crea una relazione tra tabelle." },
            { question: "Quale JOIN restituisce solo righe con corrispondenze in entrambe le tabelle?", answers: ["LEFT JOIN", "RIGHT JOIN", "FULL JOIN", "INNER JOIN"], correct: 3, explanation: "INNER JOIN seleziona record che hanno valori corrispondenti in entrambe le tabelle." },
            { question: "Cosa si intende per Prima Forma Normale (1NF)?", answers: ["Nessun gruppo ripetuto, valori atomici", "Nessuna dipendenza parziale", "Nessuna dipendenza transitiva", "Tutte le chiavi sono definite"], correct: 0, explanation: "1NF richiede che ogni cella contenga un singolo valore (atomicità) e non ci siano gruppi ripetuti di colonne." },
            { question: "Una tabella è in Seconda Forma Normale (2NF) se:", answers: ["È in 1NF e tutti gli attributi non chiave dipendono pienamente dalla chiave primaria", "Non ha dipendenze transitive", "Ha solo una chiave primaria", "Usa solo JOIN"], correct: 0, explanation: "2NF richiede che la tabella sia in 1NF e che tutti gli attributi non facenti parte della chiave primaria dipendano funzionalmente dall'intera chiave primaria (nessuna dipendenza parziale)." },
            { question: "Quando una tabella è in Terza Forma Normale (3NF)?", answers: ["Quando è molto grande", "Quando è in 2NF e non ha dipendenze transitive", "Quando non usa chiavi esterne", "Quando i dati sono crittografati"], correct: 1, explanation: "3NF richiede che la tabella sia in 2NF e che non ci siano dipendenze transitive (attributi non chiave che dipendono da altri attributi non chiave)." },
            { question: "Cosa descrive una 'dipendenza funzionale' (A -> B)?", answers: ["A causa B", "Il valore di A determina univocamente il valore di B", "A e B sono sempre uguali", "B può avere molti valori per A"], correct: 1, explanation: "A -> B significa che per ogni valore di A, c'è un solo valore possibile di B." },
            { question: "Un'anomalia di aggiornamento in una tabella non normalizzata si verifica quando:", answers: ["L'aggiornamento è troppo lento", "Bisogna aggiornare la stessa informazione in più righe", "Non si può aggiornare una chiave primaria", "L'SQL non funziona"], correct: 1, explanation: "Nelle tabelle non normalizzate, la ridondanza può costringere ad aggiornare la stessa informazione in più posti, rischiando inconsistenze." },
            { question: "La tabella `Ordini(IDOrdine, DataOrdine, IDCliente, NomeCliente, IndirizzoCliente)` che problemi di normalizzazione presenta?", answers: ["Nessuno, è perfetta", "Dipendenza parziale", "Dipendenza transitiva (NomeCliente e IndirizzoCliente dipendono da IDCliente, non da IDOrdine)", "Non è in 1NF"], correct: 2, explanation: "NomeCliente e IndirizzoCliente dipendono da IDCliente, che è un attributo non chiave. Se IDOrdine è la PK, allora IDOrdine -> IDCliente -> NomeCliente è una dipendenza transitiva." },
            { question: "Come si ordinano i risultati in ordine decrescente per una colonna 'pesoKg'?", answers: ["ORDER BY pesoKg DOWN", "SORT BY pesoKg DESC", "ORDER BY pesoKg DESCENDING", "ORDER BY pesoKg DESC"], correct: 3, explanation: "ORDER BY nomeColonna DESC ordina i risultati in modo decrescente." },
            { question: "Quale funzione di aggregazione calcola la media?", answers: ["AVERAGE()", "MEAN()", "AVG()", "MEDIAN()"], correct: 2, explanation: "AVG(nomeColonna) calcola il valore medio di una colonna numerica." },
            { question: "Per contare il numero di pacchi, quale query useresti?", answers: ["TOTAL(Pacchi)", "COUNT(*) FROM Pacchi", "NUMBER OF Pacchi", "SUM(Pacchi)"], correct: 1, explanation: "COUNT(*) conta tutte le righe in una tabella. COUNT(nomeColonna) conta le righe non-NULL per quella colonna." },
            { question: "La clausola `GROUP BY` è spesso usata con:", answers: ["ORDER BY", "Funzioni di aggregazione", "WHERE", "Subquery"], correct: 1, explanation: "GROUP BY raggruppa righe con gli stessi valori in colonne specificate, per poter applicare funzioni di aggregazione a ciascun gruppo." },
            { question: "Qual è lo scopo della clausola `HAVING`?", answers: ["Filtrare righe prima del raggruppamento", "Filtrare gruppi dopo il raggruppamento", "Un'alternativa a WHERE per le stringhe", "Definire alias"], correct: 1, explanation: "HAVING filtra i risultati dei gruppi creati da GROUP BY, basandosi su condizioni applicate alle funzioni di aggregazione." },
            { question: "Come si inseriscono nuovi dati nella tabella 'Clienti'?", answers: ["ADD INTO Clienti VALUES(...)", "CREATE Clienti VALUES(...)", "INSERT INTO Clienti VALUES(...)", "NEW Clienti VALUES(...)"], correct: 2, explanation: "INSERT INTO è il comando standard per aggiungere nuove righe." },
            { question: "Per modificare l'indirizzo di un cliente esistente, si usa:", answers: ["MODIFY Clienti SET indirizzo...", "CHANGE Clienti SET indirizzo...", "ALTER Clienti SET indirizzo...", "UPDATE Clienti SET indirizzo..."], correct: 3, explanation: "UPDATE è usato per modificare record esistenti." },
            { question: "Come si trova un pacco con `codiceTracciamento` che inizia per 'TRK123'?", answers: ["WHERE codiceTracciamento = 'TRK123%'", "WHERE codiceTracciamento STARTS WITH 'TRK123'", "WHERE codiceTracciamento LIKE 'TRK123%'", "WHERE codiceTracciamento CONTAINS 'TRK123'"], correct: 2, explanation: "L'operatore LIKE con il carattere jolly '%' permette la ricerca di pattern." },
            { question: "Se vuoi vedere solo le città uniche delle Sedi, quale query usi?", answers: ["SELECT UNIQUE cittaSede FROM Sedi", "SELECT DISTINCT cittaSede FROM Sedi", "SELECT DIFFERENT cittaSede FROM Sedi", "SELECT VARIOUS cittaSede FROM Sedi"], correct: 1, explanation: "SELECT DISTINCT restituisce solo valori unici per la colonna specificata." },
            
            // New 10 questions
            { question: "Quale tipo di dato SQL è più appropriato per memorizzare un prezzo come 19.99?", answers: ["INTEGER", "TEXT", "BOOLEAN", "DECIMAL(10,2)"], correct: 3, explanation: "DECIMAL o NUMERIC (o REAL/FLOAT in alcuni DB) sono usati per numeri con cifre decimali, essenziali per i valori monetari. INTEGER è solo per numeri interi." },
            { question: "Come si verifica se un valore nella colonna `noteOpzionali` è mancante (NULL)?", answers: ["WHERE noteOpzionali = ''", "WHERE noteOpzionali = NULL", "WHERE noteOpzionali IS NULL", "WHERE noteOpzionali IS EMPTY"], correct: 2, explanation: "Per verificare la presenza di NULL, si usa IS NULL (o IS NOT NULL). Il confronto diretto con NULL (es. = NULL) non funziona come ci si aspetterebbe." },
            { question: "Quale vincolo (constraint) assicura che tutti i valori in una colonna `codiceFiscale` siano unici?", answers: ["PRIMARY KEY", "UNIQUE", "CHECK (codiceFiscale IS DISTINCT)", "NOT NULL"], correct: 1, explanation: "Il vincolo UNIQUE garantisce che ogni valore nella colonna sia diverso dagli altri, consentendo però valori NULL (a meno che non sia specificato anche NOT NULL)." },
            { question: "Quale comando SQL si usa per aggiungere una nuova colonna a una tabella esistente?", answers: ["MODIFY TABLE", "UPDATE TABLE", "ALTER TABLE", "CHANGE TABLE"], correct: 2, explanation: "ALTER TABLE è il comando DDL (Data Definition Language) utilizzato per modificare la struttura di una tabella esistente." },
            { question: "Se esegui `DELETE FROM Pacchi;` (senza una clausola WHERE), cosa succede?", answers: ["Viene eliminata la tabella Pacchi.", "Vengono eliminate tutte le righe dalla tabella Pacchi.", "Viene generato un errore perché manca WHERE.", "Nulla, è un comando non valido."], correct: 1, explanation: "DELETE FROM nomeTabella senza WHERE rimuove tutte le righe, ma la struttura della tabella rimane. DROP TABLE elimina la tabella intera." },
            { question: "Qual è la differenza principale tra `UNION` e `UNION ALL`?", answers: ["UNION è più veloce.", "UNION ALL rimuove i duplicati, UNION no.", "UNION rimuove i duplicati, UNION ALL no.", "Non c'è differenza funzionale."], correct: 2, explanation: "UNION combina i risultati di due SELECT e rimuove i duplicati. UNION ALL include tutte le righe, comprese le duplicate, ed è generalmente più veloce." },
            { question: "In quale scenario è utile una subquery con l'operatore `IN`?", answers: ["Per calcolare una media.", "Per verificare se un valore esiste in un set di risultati di un'altra query.", "Per unire due tabelle.", "Per ordinare i risultati."], correct: 1, explanation: "WHERE colonna IN (SELECT altra_colonna FROM ...) permette di filtrare le righe basandosi sui valori restituiti dalla subquery." },
            { question: "A cosa serve la parola chiave `AS` in una query SQL?", answers: ["Per creare una nuova tabella.", "Per definire un tipo di dato.", "Per assegnare un nome temporaneo (alias) a una colonna o tabella.", "Per eseguire un'asserzione."], correct: 2, explanation: "AS è usato per dare un alias a colonne o tabelle, rendendo le query più leggibili o i nomi delle colonne nel risultato più significativi." },
            { question: "Cosa fa il comando `COMMIT` in una transazione SQL?", answers: ["Annulla le modifiche della transazione.", "Salva permanentemente le modifiche della transazione.", "Inizia una nuova transazione.", "Controlla la sintassi della transazione."], correct: 1, explanation: "COMMIT finalizza una transazione, rendendo permanenti tutte le modifiche al database eseguite dall'inizio della transazione." },
            { question: "Qual è lo scopo principale di creare un indice su una colonna?", answers: ["Garantire l'unicità dei dati.", "Migliorare la velocità delle query di ricerca (SELECT).", "Ridurre lo spazio della tabella.", "Facilitare i backup."], correct: 1, explanation: "Gli indici accelerano il recupero dei dati. Sebbene alcuni indici (es. per PK) garantiscano l'unicità, lo scopo primario è la performance delle SELECT." }
        ];
        
        const syntaxChallenges = [
            { 
                description: "Seleziona tutte le colonne e tutte le righe dalla tabella 'Sedi'.", 
                solutionTokens: ["SELECT", "*", "FROM", "Sedi"],
                availableButtons: ["SELECT", "*", "FROM", "Sedi", "Clienti", "WHERE", "nomeSede", "cittaSede", ",", ";"] 
            },
            { 
                description: "Mostra solo le colonne 'nomeSede' e 'cittaSede' dalla tabella 'Sedi'.",
                solutionTokens: ["SELECT", "nomeSede", ",", "cittaSede", "FROM", "Sedi"],
                availableButtons: ["SELECT", "nomeSede", "cittaSede", "indirizzoSede", "*", "FROM", "Sedi", "Clienti", "WHERE", ",", ";"]
            },
            {
                description: "Seleziona tutti i pacchi dalla tabella 'Pacchi' dove 'cittaDestinatario' è 'Roma'.",
                solutionTokens: ["SELECT", "*", "FROM", "Pacchi", "WHERE", "cittaDestinatario", "=", "'Roma'"],
                availableButtons: ["SELECT", "*", "FROM", "Pacchi", "Sedi", "WHERE", "cittaDestinatario", "pesoKg", "=", "<", ">", "'Roma'", "'Milano'", ";"]
            }
        ];

        const challenges = [
            // Basic SELECTs
            { phase: 1, title: "Elenco Sedi", description: "Mostra tutti i dati di tutte le sedi logistiche.", hint: "Usa `SELECT * FROM nome_tabella;`", solution: "SELECT * FROM Sedi;" },
            { phase: 1, title: "Anagrafica Clienti", description: "Mostra nome, cognome e tipo di tutti i clienti.", hint: "Seleziona le colonne `nomeCliente`, `cognomeCliente`, `tipoCliente` dalla tabella `Clienti`.", solution: "SELECT nomeCliente, cognomeCliente, tipoCliente FROM Clienti;" },
            { phase: 1, title: "Inventario Pacchi Semplice", description: "Mostra il codice di tracciamento e la descrizione di tutti i pacchi.", hint: "Seleziona `codiceTracciamento` e `descrizione` da `Pacchi`.", solution: "SELECT codiceTracciamento, descrizione FROM Pacchi;" },
            // Filtering (WHERE)
            { phase: 1, title: "Sedi Milanesi", description: "Trova tutte le sedi situate a 'Milano'.", hint: "Usa `WHERE cittaSede = 'Milano'`.", solution: "SELECT * FROM Sedi WHERE cittaSede = 'Milano';" },
            { phase: 1, title: "Pacchi Pesanti", description: "Elenca i pacchi con un peso superiore a 10 Kg.", hint: "Filtra `Pacchi` per `pesoKg > 10`.", solution: "SELECT * FROM Pacchi WHERE pesoKg > 10;" },
            { phase: 1, title: "Pacchi in Transito", description: "Trova tutte le spedizioni attualmente 'In transito'. Considera l'ultimo stato per ogni pacco.", 
              hint: "Identifica l'ultimo evento per ogni pacco e poi filtra per stato. Potrebbe richiedere una subquery o un approccio con MAX(dataOraEvento) e GROUP BY idPacco, per poi unire di nuovo per ottenere lo stato.",
              solution: "SELECT s.* FROM Spedizioni s INNER JOIN (SELECT idPacco, MAX(dataOraEvento) AS MaxData FROM Spedizioni GROUP BY idPacco) sm ON s.idPacco = sm.idPacco AND s.dataOraEvento = sm.MaxData WHERE s.statoSpedizione = 'In transito';"
            },
            // Sorting (ORDER BY)
            { phase: 2, title: "Pacchi per Peso", description: "Mostra codice tracciamento, descrizione e peso dei pacchi, ordinati per peso in ordine decrescente.", hint: "Usa `ORDER BY pesoKg DESC`.", solution: "SELECT codiceTracciamento, descrizione, pesoKg FROM Pacchi ORDER BY pesoKg DESC;" },
            // Aggregations & GROUP BY
            { phase: 2, title: "Conteggio Pacchi per Stato", description: "Conta quanti pacchi ci sono per ogni `statoSpedizione` nell'ultimo evento di spedizione registrato per ciascun pacco.", 
              hint: "Prima trova l'ultimo stato di ogni pacco (come nella sfida 'Pacchi in Transito'), poi raggruppa per `statoSpedizione` e conta.", 
              solution: "SELECT s.statoSpedizione, COUNT(s.idPacco) AS numeroPacchi FROM Spedizioni s INNER JOIN (SELECT idPacco, MAX(dataOraEvento) AS MaxData FROM Spedizioni GROUP BY idPacco) sm ON s.idPacco = sm.idPacco AND s.dataOraEvento = sm.MaxData GROUP BY s.statoSpedizione;" 
            },
            { phase: 2, title: "Capacità Totale Sedi per Città", description: "Calcola la capacità massima totale di pacchi per ogni città che ha almeno una sede.", hint: "Usa `SUM(capacitaMaxPacchi)` e `GROUP BY cittaSede`.", solution: "SELECT cittaSede, SUM(capacitaMaxPacchi) AS capacitaTotale FROM Sedi GROUP BY cittaSede;" },
            // JOINs
            { phase: 3, title: "Pacchi e Mittenti", description: "Mostra il codice di tracciamento del pacco e il nome e cognome del cliente mittente.", hint: "Unisci `Pacchi` (p) e `Clienti` (c) su `p.idClienteMittente = c.idCliente`.", solution: "SELECT p.codiceTracciamento, c.nomeCliente, c.cognomeCliente FROM Pacchi p JOIN Clienti c ON p.idClienteMittente = c.idCliente;" },
            { phase: 3, title: "Pacchi e Loro Sede Corrente", description: "Mostra il codice tracciamento del pacco e il nome della sua sede corrente (basato sull'ultimo evento di spedizione).", 
              hint: "Trova l'ultimo evento per ogni pacco, poi unisci con `Sedi` per ottenere `nomeSede`.", 
              solution: "SELECT p.codiceTracciamento, sed.nomeSede AS sedeCorrente FROM Pacchi p JOIN Spedizioni s ON p.idPacco = s.idPacco JOIN (SELECT idPacco, MAX(dataOraEvento) AS MaxData FROM Spedizioni GROUP BY idPacco) sm ON s.idPacco = sm.idPacco AND s.dataOraEvento = sm.MaxData JOIN Sedi sed ON s.idSedeCorrente = sed.idSede;"
            },
            // Advanced
            { phase: 4, title: "Clienti con Più di Un Pacco Spedito", description: "Trova i clienti (ID e nome) che hanno spedito più di un pacco.", hint: "Raggruppa `Pacchi` per `idClienteMittente`, conta i pacchi e usa `HAVING COUNT(*) > 1`. Poi unisci con `Clienti`.", solution: "SELECT c.idCliente, c.nomeCliente, c.cognomeCliente, COUNT(p.idPacco) AS numeroPacchiSpediti FROM Clienti c JOIN Pacchi p ON c.idCliente = p.idClienteMittente GROUP BY c.idCliente, c.nomeCliente, c.cognomeCliente HAVING COUNT(p.idPacco) > 1;" },
            { phase: 4, title: "Pacchi Più Pesanti della Media", description: "Elenca i pacchi (codice tracciamento e peso) che pesano più del peso medio di tutti i pacchi.", hint: "Usa una subquery per calcolare `AVG(pesoKg)` da `Pacchi`.", solution: "SELECT codiceTracciamento, pesoKg FROM Pacchi WHERE pesoKg > (SELECT AVG(pesoKg) FROM Pacchi);" },
            { phase: 4, title: "Ultimo Stato per Pacco TRK001", description: "Trova l'ultimo stato registrato per il pacco con `codiceTracciamento` 'TRK001'. Mostra stato e data/ora evento.", 
              hint: "Filtra `Spedizioni` per `idPacco` corrispondente a 'TRK001', poi ordina per `dataOraEvento DESC` e prendi il primo (`LIMIT 1`).", 
              solution: "SELECT s.statoSpedizione, s.dataOraEvento FROM Spedizioni s JOIN Pacchi p ON s.idPacco = p.idPacco WHERE p.codiceTracciamento = 'TRK001' ORDER BY s.dataOraEvento DESC LIMIT 1;"
            }
        ];

        async function initSqlJsDatabase() {
            try {
                const SQL = await initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${file}` });
                db = new SQL.Database();

                // Creazione Tabelle
                db.run("CREATE TABLE Sedi (idSede INTEGER PRIMARY KEY, nomeSede TEXT, indirizzoSede TEXT, cittaSede TEXT, capacitaMaxPacchi INTEGER);");
                db.run("CREATE TABLE Clienti (idCliente INTEGER PRIMARY KEY, nomeCliente TEXT, cognomeCliente TEXT, tipoCliente TEXT, email TEXT, telefono TEXT);");
                db.run("CREATE TABLE Pacchi (idPacco INTEGER PRIMARY KEY, codiceTracciamento TEXT UNIQUE, descrizione TEXT, pesoKg REAL, volumeM3 REAL, valoreAssicurato REAL, idClienteMittente INTEGER, nomeDestinatario TEXT, indirizzoDestinatario TEXT, cittaDestinatario TEXT, capDestinatario TEXT, FOREIGN KEY (idClienteMittente) REFERENCES Clienti(idCliente));");
                db.run("CREATE TABLE Spedizioni (idSpedizione INTEGER PRIMARY KEY AUTOINCREMENT, idPacco INTEGER, idSedeCorrente INTEGER, idSedeDestinazioneFinale INTEGER, dataOraEvento TEXT, statoSpedizione TEXT, noteEvento TEXT, FOREIGN KEY (idPacco) REFERENCES Pacchi(idPacco), FOREIGN KEY (idSedeCorrente) REFERENCES Sedi(idSede), FOREIGN KEY (idSedeDestinazioneFinale) REFERENCES Sedi(idSede));");

                // Inserimento Dati Campione
                sampleData.Sedi.forEach(row => db.run("INSERT INTO Sedi VALUES (?, ?, ?, ?, ?);", [row.idSede, row.nomeSede, row.indirizzoSede, row.cittaSede, row.capacitaMaxPacchi]));
                sampleData.Clienti.forEach(row => db.run("INSERT INTO Clienti VALUES (?, ?, ?, ?, ?, ?);", [row.idCliente, row.nomeCliente, row.cognomeCliente, row.tipoCliente, row.email, row.telefono]));
                sampleData.Pacchi.forEach(row => db.run("INSERT INTO Pacchi VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);", [row.idPacco, row.codiceTracciamento, row.descrizione, row.pesoKg, row.volumeM3, row.valoreAssicurato, row.idClienteMittente, row.nomeDestinatario, row.indirizzoDestinatario, row.cittaDestinatario, row.capDestinatario]));
                sampleData.Spedizioni.forEach(row => db.run("INSERT INTO Spedizioni (idPacco, idSedeCorrente, idSedeDestinazioneFinale, dataOraEvento, statoSpedizione, noteEvento) VALUES (?, ?, ?, ?, ?, ?);", [row.idPacco, row.idSedeCorrente, row.idSedeDestinazioneFinale, row.dataOraEvento, row.statoSpedizione, row.noteEvento]));
                
                console.log("Database Logistico SQL.js inizializzato e popolato.");
            } catch (err) {
                console.error("Errore inizializzazione SQL.js:", err);
                Swal.fire({ icon: 'error', title: 'Errore Caricamento Database', text: 'Impossibile inizializzare il database SQL.js. Ricarica la pagina.', confirmButtonColor: '#ef4444' });
            }
        }
        
        async function initGame() {
            await initSqlJsDatabase();
            document.getElementById('total-challenges-count').textContent = challenges.length;
        }

        // --- FUNZIONI UI E LOGICA GIOCO (largamente invariate da code5.html, adattate dove necessario) ---
        function showScreen(screenId) {
            ['welcome-screen', 'quiz-section', 'syntax-builder-section', 'lab-section', 'game-phases'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            if (screenId) {
                 document.getElementById(screenId).classList.remove('hidden');
            }
        }

        function startQuiz() {
            showScreen('quiz-section');
            loadQuizQuestion();
        }

        function startSyntaxBuilder() {
            showScreen('syntax-builder-section');
            gameState.currentSyntaxChallengeIndex = 0;
            gameState.builtQueryTokens = [];
            loadSyntaxChallenge();
        }
        
        function skipSyntaxBuilderAndStartLab() {
            startLab();
        }

        function startLab() {
            showScreen('lab-section');
            document.getElementById('game-phases').classList.remove('hidden'); 
            if (!db) { 
                initSqlJsDatabase().then(() => loadChallenge());
            } else {
                loadChallenge();
            }
        }
        
        function directToLab() { 
            startLab();
        }

        function loadQuizQuestion() {
            const question = quizQuestions[gameState.currentQuiz];
            document.getElementById('question-text').textContent = question.question;
            document.getElementById('current-question').textContent = gameState.currentQuiz + 1;
            document.getElementById('total-questions').textContent = quizQuestions.length; // Dynamically updates based on array length
            
            const answersContainer = document.getElementById('answers');
            answersContainer.innerHTML = '';
            
            question.answers.forEach((answer, index) => {
                const button = document.createElement('button');
                button.className = 'w-full text-left p-3 bg-gray-700 hover:bg-gray-600 rounded-lg transition-all';
                button.textContent = answer;
                button.onclick = () => selectAnswer(index);
                answersContainer.appendChild(button);
            });
            updateQuizButtons();
        }

        function selectAnswer(index) {
            const question = quizQuestions[gameState.currentQuiz];
            const buttons = document.querySelectorAll('#answers button');
            
            buttons.forEach((btn, i) => {
                btn.classList.remove('bg-green-500', 'bg-red-500'); 
                if (i === question.correct) {
                    btn.classList.add('bg-green-500'); 
                } else if (i === index && i !== question.correct) {
                    btn.classList.add('bg-red-500'); 
                }
                btn.disabled = true;
            });

            Swal.fire({ 
                icon: index === question.correct ? 'success' : 'error', 
                title: index === question.correct ? 'Corretto!' : 'Sbagliato!', 
                html: `<p class="mb-2">${question.explanation}</p>`, 
                confirmButtonColor: index === question.correct ? '#10b981' : '#ef4444',
                timer: index === question.correct ? 3000: 4000,
                showConfirmButton: true, 
                confirmButtonText: 'OK'
            }).then(() => { 
                 if (!document.getElementById('next-btn').disabled || gameState.currentQuiz === quizQuestions.length - 1) {
                     nextQuestion();
                }
            });
        }
        
        function nextQuestion() {
            if (gameState.currentQuiz < quizQuestions.length - 1) {
                gameState.currentQuiz++;
                loadQuizQuestion();
            } else {
                Swal.fire({
                    icon: 'success',
                    title: 'Quiz Completato!',
                    text: `Hai risposto a tutte le domande di teoria. Ora passiamo al costruttore di query base!`,
                    confirmButtonColor: '#3b82f6'
                }).then(() => {
                    startSyntaxBuilder();
                });
            }
        }

        function previousQuestion() {
            if (gameState.currentQuiz > 0) {
                gameState.currentQuiz--;
                loadQuizQuestion();
            }
        }

        function updateQuizButtons() {
            document.getElementById('prev-btn').disabled = gameState.currentQuiz === 0;
            const nextBtn = document.getElementById('next-btn');
            nextBtn.textContent = gameState.currentQuiz === quizQuestions.length - 1 ? 'Finisci Quiz e Vai Avanti' : 'Prossima';
        }

        function loadSyntaxChallenge() {
            if (gameState.currentSyntaxChallengeIndex >= syntaxChallenges.length) {
                Swal.fire({
                    icon: 'success',
                    title: 'Costruttore Query Completato!',
                    text: "Ottimo lavoro con le query base! Sei pronto per il Laboratorio SQL Logistico.",
                    confirmButtonColor: '#3b82f6'
                }).then(() => {
                    startLab();
                });
                return;
            }
            const challenge = syntaxChallenges[gameState.currentSyntaxChallengeIndex];
            document.getElementById('syntax-challenge-description').textContent = challenge.description;
            
            const buttonsContainer = document.getElementById('syntax-buttons-container');
            buttonsContainer.innerHTML = '';
            challenge.availableButtons.forEach(token => {
                const button = document.createElement('button');
                button.className = 'bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-md text-sm font-mono';
                button.textContent = token;
                button.onclick = () => addSyntaxToken(token);
                buttonsContainer.appendChild(button);
            });
            updateBuiltQueryDisplay();
            document.getElementById('check-syntax-btn').disabled = false;
        }

        function addSyntaxToken(token) {
            gameState.builtQueryTokens.push(token);
            updateBuiltQueryDisplay();
        }

        function undoLastSyntaxToken() {
            gameState.builtQueryTokens.pop();
            updateBuiltQueryDisplay();
        }

        function clearBuiltQuery() {
            gameState.builtQueryTokens = [];
            updateBuiltQueryDisplay();
        }

        function updateBuiltQueryDisplay() {
            document.getElementById('built-query-display').textContent = gameState.builtQueryTokens.join(' ').replace(/\s*;\s*$/, '') + ';'; 
        }

        function checkSyntaxChallenge() {
            const currentChallengeDef = syntaxChallenges[gameState.currentSyntaxChallengeIndex];
            let userQuery = gameState.builtQueryTokens.join(' ').replace(/\s*;\s*$/, '').trim() + ';';
            let expectedQuery = currentChallengeDef.solutionTokens.join(' ').replace(/\s*;\s*$/, '').trim() + ';';
            
            if (userQuery.toLowerCase() === expectedQuery.toLowerCase()) { 
                Swal.fire({
                    icon: 'success', title: 'Corretto!', text: 'Query costruita correttamente!', timer: 1500, showConfirmButton: false
                }).then(() => {
                    gameState.currentSyntaxChallengeIndex++;
                    gameState.builtQueryTokens = [];
                    loadSyntaxChallenge();
                });
            } else {
                Swal.fire({ icon: 'error', title: 'Non Corretto', text: 'La query costruita non è quella attesa. Riprova!', confirmButtonColor: '#ef4444'});
            }
        }

        function loadChallenge() {
            if (gameState.currentChallengeIndex >= challenges.length) {
                completeGame();
                return;
            }
            const challenge = challenges[gameState.currentChallengeIndex];
            document.getElementById('challenge-title').textContent = challenge.title;
            document.getElementById('challenge-description').textContent = challenge.description;
            document.getElementById('challenge-counter').textContent = gameState.currentChallengeIndex + 1;
            updateChallengeProgress();
        }

        function updateChallengeProgress() {
            const progress = ((gameState.currentChallengeIndex) / challenges.length) * 100;
            document.getElementById('challenge-progress-fill').style.width = `${progress}%`;
            document.getElementById('progress-text').textContent = `Sfida ${gameState.currentChallengeIndex} di ${challenges.length} completata.`;
             if (gameState.currentChallengeIndex === challenges.length) {
                document.getElementById('progress-text').textContent = `Tutte le ${challenges.length} sfide completate! Congratulazioni!`;
            }
        }
        
        async function executeQueryAndDisplay(query) {
            if (!db) {
                Swal.fire({ icon: 'error', title: 'Database non pronto', text: 'Attendi il caricamento.', confirmButtonColor: '#f59e0b' });
                return { success: false, errorType: 'db_not_ready' };
            }
            if (!query) {
                return { success: false, errorType: 'empty_query' };
            }
            try {
                const resultsArray = db.exec(query);
                displayQueryResults(resultsArray);
                return { success: true, results: resultsArray };
            } catch (e) {
                Swal.fire({
                    icon: 'error', title: 'Errore SQL!', 
                    html: `<p>Errore nell'esecuzione:</p><pre class="text-left text-sm bg-gray-800 p-2 rounded mt-2">${e.message}</pre>`, 
                    confirmButtonColor: '#ef4444'
                });
                displayQueryResults([]); 
                return { success: false, errorType: 'sql_error', message: e.message };
            }
        }

        async function testQuery() {
            const query = document.getElementById('sql-editor').value.trim();
            if (!query) {
                Swal.fire({ icon: 'warning', title: 'Query Vuota', text: 'Scrivi una query prima di testarla!', confirmButtonColor: '#f59e0b' });
                return;
            }
            await executeQueryAndDisplay(query);
        }

        async function submitQuery() {
            const query = document.getElementById('sql-editor').value.trim();
            if (!query) {
                Swal.fire({ icon: 'warning', title: 'Query Vuota', text: 'Scrivi una query prima di sottoporla!', confirmButtonColor: '#f59e0b' });
                return;
            }

            const executionResult = await executeQueryAndDisplay(query);

            if (executionResult.success) {
                const currentChallenge = challenges[gameState.currentChallengeIndex];
                if (checkQueryCorrectness(query, currentChallenge)) {
                    Swal.fire({
                        icon: 'success', title: '🎉 Corretto!', text: `Ottimo lavoro! Sfida superata.`, 
                        confirmButtonColor: '#10b981', timer: 2000, showConfirmButton: false
                    }).then(() => {
                        nextChallenge();
                    });
                } else {
                     Swal.fire({
                        icon: 'info', title: 'Risultato Diverso dal Previsto', 
                        text: "La query è valida, ma il risultato non corrisponde alla soluzione attesa. Controlla i dati o la logica. Usa l'aiuto se necessario.", 
                        confirmButtonColor: '#3b82f6'
                    });
                }
            }
        }

        function compareResults(res1, res2) {
            if (!res1 && !res2) return true;
            if (!res1 || !res2) return false;

            const r1Cols = (res1.columns || []).map(c => String(c).toLowerCase()).sort();
            const r2Cols = (res2.columns || []).map(c => String(c).toLowerCase()).sort();

            if (r1Cols.length !== r2Cols.length) return false;
            for (let i = 0; i < r1Cols.length; i++) {
                if (r1Cols[i] !== r2Cols[i]) return false;
            }
            
            const v1Values = res1.values || [];
            const v2Values = res2.values || [];

            if (v1Values.length !== v2Values.length) return false;
            if (v1Values.length === 0) return true;

            const normalizeRow = (row, columnOrderOriginal, columnOrderCanonical) => {
                const mappedRow = {};
                columnOrderOriginal.forEach((colName, idx) => {
                    mappedRow[String(colName).toLowerCase()] = String(row[idx]);
                });
                
                const orderedRow = [];
                 columnOrderCanonical.forEach(canonicalColName => { 
                    orderedRow.push(mappedRow[canonicalColName]);
                });
                return JSON.stringify(orderedRow);
            };
            
            const canonicalColumnOrder = r2Cols; 

            const v1 = v1Values.map(row => normalizeRow(row, res1.columns, canonicalColumnOrder)).sort();
            const v2 = v2Values.map(row => normalizeRow(row, res2.columns, canonicalColumnOrder)).sort();
            
            for (let i = 0; i < v1.length; i++) {
                if (v1[i] !== v2[i]) return false;
            }
            return true;
        }

        function checkQueryCorrectness(userQuery, challenge) {
            if (!db) return false;
            try {
                const userResultsRaw = db.exec(userQuery);
                const solutionResultsRaw = db.exec(challenge.solution);

                const userResult = (userResultsRaw.length > 0 && userResultsRaw[0].columns) ? userResultsRaw[0] : { columns: [], values: [] };
                const solutionResult = (solutionResultsRaw.length > 0 && solutionResultsRaw[0].columns) ? solutionResultsRaw[0] : { columns: [], values: [] };
                
                if (userResultsRaw.length === 0 && solutionResultsRaw.length === 0) return true; 
                if ((userResultsRaw.length === 0 && solutionResult.columns.length > 0) || (solutionResultsRaw.length === 0 && userResult.columns.length > 0)) return false;
                if (!userResult.columns && solutionResult.columns) return false;
                if (userResult.columns && !solutionResult.columns) return false;

                return compareResults(userResult, solutionResult);
            } catch (e) {
                console.error("Errore durante controllo soluzione:", e.message, "UserQ:", userQuery, "SolQ:", challenge.solution);
                return false; 
            }
        }
        
        function displayQueryResults(resultsArray) {
            const resultsContainer = document.getElementById('query-results');
            resultsContainer.innerHTML = ''; 

            if (!resultsArray || resultsArray.length === 0) {
                resultsContainer.innerHTML = '<p class="text-gray-400 p-4">Query eseguita. Nessun set di risultati (es. comandi non-SELECT o nessun dato).</p>';
            } else {
                resultsArray.forEach((result) => {
                    if (result && result.columns && result.values) {
                        const tableElement = createTableFromSqlJsResult(result);
                        resultsContainer.appendChild(tableElement);
                    } else if (resultsArray.length === 1 && Object.keys(result).length === 0 && !result.columns && !result.values) {
                        resultsContainer.innerHTML = '<p class="text-green-400 p-4">Comando SQL (non-SELECT) eseguito con successo.</p>';
                    } else {
                         resultsContainer.innerHTML = '<p class="text-yellow-400 p-4">Risultato non tabulare o inatteso.</p>';
                    }
                });
            }
        }

        function createTableFromSqlJsResult(sqlJsResult) {
            const table = document.createElement('table');
            table.className = 'w-full text-sm text-left';
            
            if (!sqlJsResult.columns || sqlJsResult.columns.length === 0) {
                const p = document.createElement('p');
                p.className = "p-4 text-gray-400";
                p.textContent = (sqlJsResult.values && sqlJsResult.values.length > 0) ? "Dati presenti ma senza nomi colonna." : "Nessun record per questo risultato.";
                return p;
            }

            const thead = table.createTHead();
            const headerRow = thead.insertRow();
            sqlJsResult.columns.forEach(headerText => {
                const th = document.createElement('th');
                th.className = 'px-4 py-2 sticky top-0 z-10 bg-gray-700 text-white';
                th.textContent = headerText;
                headerRow.appendChild(th);
            });

            const tbody = table.createTBody();
            if (sqlJsResult.values.length === 0) {
                const tr = tbody.insertRow();
                const td = tr.insertCell();
                td.colSpan = sqlJsResult.columns.length;
                td.className = 'px-4 py-2 text-center text-gray-400';
                td.textContent = 'Nessun record trovato.';
            } else {
                sqlJsResult.values.forEach((rowArray, rowIndex) => {
                    const tr = tbody.insertRow();
                    tr.className = rowIndex % 2 === 0 ? 'bg-slate-800' : 'bg-slate-900'; 
                    rowArray.forEach(cellData => {
                        const td = tr.insertCell();
                        td.className = 'px-4 py-2 border-t border-gray-700';
                        td.textContent = cellData === null ? 'NULL' : String(cellData);
                    });
                });
            }
            return table;
        }

        function clearEditor() {
            document.getElementById('sql-editor').value = '';
        }

        function showHint() {
            if (gameState.currentChallengeIndex >= challenges.length) return;
            const challenge = challenges[gameState.currentChallengeIndex];
            Swal.fire({ icon: 'info', title: 'Suggerimento Sfida', text: challenge.hint, confirmButtonColor: '#3b82f6', customClass: {popup: 'glass-effect', htmlContainer: 'text-white'} });
        }

        function nextChallenge() {
            gameState.currentChallengeIndex++;
             updateChallengeProgress(); 
            if (gameState.currentChallengeIndex < challenges.length) {
                loadChallenge();
                document.getElementById('sql-editor').value = ''; 
                document.getElementById('query-results').innerHTML = '<p class="text-gray-400 p-4">Testa o sottoponi una query.</p>'; 
            } else {
                completeGame();
            }
        }
        
        function showCheatSheet() {
            Swal.fire({
                title: '📚 SQL Cheat Sheet & Normalizzazione',
                html: `
                    <div class="text-left text-sm space-y-3 p-4 bg-gray-800 rounded-lg max-h-[70vh] overflow-y-auto">
                        <h4 class="font-bold text-teal-400">Comandi Base:</h4>
                        <p><strong>SELECT</strong> col1, col2 FROM tabella;</p>
                        <p><strong>SELECT *</strong> FROM tabella;</p>
                        <p><strong>WHERE</strong> condizione; (Operatori: =, <, >, <=, >=, !=, LIKE, IN, BETWEEN, IS NULL)</p>
                        <p><strong>AND / OR / NOT:</strong> WHERE cond1 AND cond2;</p>
                        <p><strong>ORDER BY</strong> col1 ASC/DESC;</p>
                        <h4 class="font-bold text-teal-400 mt-2">JOINs:</h4>
                        <p><strong>INNER JOIN</strong> tab2 ON tab1.id = tab2.id;</p>
                        <p><strong>LEFT JOIN</strong> tab2 ON tab1.id = tab2.id;</p>
                        <h4 class="font-bold text-teal-400 mt-2">Aggregazioni:</h4>
                        <p><strong>COUNT</strong>(col/*), <strong>SUM</strong>(col), <strong>AVG</strong>(col), <strong>MAX</strong>(col), <strong>MIN</strong>(col)</p>
                        <p><strong>GROUP BY</strong> col1, col2;</p>
                        <p><strong>HAVING</strong> condizione_aggregata; (dopo GROUP BY)</p>
                        <h4 class="font-bold text-teal-400 mt-2">Altri Comandi Utili:</h4>
                        <p><strong>DISTINCT</strong> col1; (valori unici)</p>
                        <p><strong>AS</strong> alias_colonna/tabella;</p>
                        <p><strong>LIMIT</strong> N; (prime N righe)    <strong>OFFSET</strong> M; (salta M righe)</p>
                        <p><strong>INSERT INTO</strong> tab (c1,c2) VALUES (v1,v2);</p>
                        <p><strong>UPDATE</strong> tab SET c1=v1 WHERE cond;</p>
                        <p><strong>DELETE FROM</strong> tab WHERE cond;</p>
                        <h4 class="font-bold text-red-400 mt-3">Normalizzazione:</h4>
                        <p><strong>1NF (Prima Forma Normale):</strong> Ogni cella ha un valore atomico (singolo). No gruppi ripetuti di colonne.</p>
                        <p><strong>2NF (Seconda Forma Normale):</strong> In 1NF + Tutti gli attributi non-chiave dipendono funzionalmente dall'INTERA chiave primaria (no dipendenze parziali).</p>
                        <p><strong>3NF (Terza Forma Normale):</strong> In 2NF + Nessun attributo non-chiave dipende da un altro attributo non-chiave (no dipendenze transitive).</p>
                        <p><em>Dipendenza Funzionale (A → B):</em> Il valore di A determina univocamente B.</p>
                        <p><em>Dipendenza Parziale:</em> Un attributo non-chiave dipende solo da una PARTE di una chiave primaria composita.</p>
                        <p><em>Dipendenza Transitiva:</em> A → B e B → C, dove A è la PK, B e C sono non-chiave. Quindi A → C transitivamente.</p>
                    </div>
                `,
                confirmButtonText: 'Ho Letto!',
                confirmButtonColor: '#3b82f6',
                width: 'auto', 
                customClass: { popup: 'glass-effect max-w-2xl w-full', htmlContainer: 'text-white' }
            });
        }

        function completeGame() {
            updateChallengeProgress();
            Swal.fire({
                iconHtml: '<span class="text-6xl">🏆</span>',
                title: `Complimenti, Esperto di Logistica SQL!`,
                html: `
                    <div class="text-center space-y-4 text-white">
                        <h3 class="text-2xl font-bold">Missione Compiuta!</h3>
                        <p class="text-lg">Hai navigato con successo tutte le sfide del Gestore Logistico Digitale!</p>
                        <p>Le tue abilità SQL sono ora pronte per ottimizzare qualsiasi catena di approvvigionamento!</p>
                    </div>
                `,
                confirmButtonText: 'Ricomincia Avventura',
                confirmButtonColor: '#10b981',
                customClass: { popup: 'glass-effect' }
            }).then((result) => {
                if (result.isConfirmed) {
                    location.reload();
                }
            });
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            initGame(); 
            document.addEventListener('keydown', function(e) {
                if (!document.getElementById('lab-section').classList.contains('hidden')) {
                    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') { e.preventDefault(); submitQuery(); } 
                    else if ((e.ctrlKey || e.metaKey) && e.key === 'k') { e.preventDefault(); clearEditor(); }
                }
            });
        });
    </script>
</body>
</html>